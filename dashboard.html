<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ÙÙˆØ§ØªÙŠØ±</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif}
body{background:#f4f7f6;color:#333}
header{background:#0b5fa5;color:#fff;padding:20px;text-align:center;font-size:24px;font-weight:bold}
.container{max-width:1100px;margin:auto;padding:20px}
.card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:30px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#0b5fa5;color:#fff}
button{padding:8px 15px;border:none;border-radius:8px;cursor:pointer;margin:5px}
.invoice th{background:#0fa36b}
.invoice tfoot td{background:#6bcf63;color:#fff}
input{padding:8px;border-radius:8px;border:1px solid #ccc;margin-bottom:10px;width:48%}
.actions button{margin-bottom:10px}
</style>
</head>
<body>

<header>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ÙÙˆØ§ØªÙŠØ±</header>

<div class="container">

<h2>ğŸ“Š ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
<div class="card" id="invoiceCard">
<div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">

  <input type="text" id="customerName" 
  placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"
  style="padding:8px;border-radius:8px;border:1px solid #ccc;flex:1">

  <input type="text" id="customerPhone" 
  placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø¯ÙˆÙ† 0"
  style="padding:8px;border-radius:8px;border:1px solid #ccc;flex:1">

  <button onclick="saveCustomerOnly()" 
  style="background:#0fa36b;color:#fff;border:none;border-radius:8px;padding:8px 12px">
  â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø£Ø±Ø´ÙŠÙ
  </button>

</div>

<div id="invoiceHeader" style="text-align:center;margin:15px 0">
<h3>ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡</h3>
<p>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: <span id="invoiceNumber"></span></p>
<p>Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="invoiceDate"></span></p>
</div>

<table class="invoice" id="invoiceTable">
<thead>
<tr>
<th>Ø§Ù„Ù…Ù†ØªØ¬</th>
<th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
<th>Ø§Ù„Ø³Ø¹Ø±</th>
<th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
<td colspan="3"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</strong></td>
<td id="totalAmount">0 Ø¯.Ø£</td>
</tr>
</tfoot>
</table>

<div class="actions">

<button onclick="downloadImage()">ğŸ“· ØªÙ†Ø²ÙŠÙ„ ØµÙˆØ±Ø©</button>
<button onclick="sendWhatsApp()">ğŸ“² ÙˆØ§ØªØ³Ø§Ø¨</button>

</div>

</div>

<h2>ğŸ“ Ø£Ø±Ø´ÙŠÙ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
<div class="card">
<table id="archiveTable">
<thead>
<tr>
<th>Ø±Ù‚Ù…</th>
<th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
<th>Ø§Ù„Ù‡Ø§ØªÙ</th>
<th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>

<script>

function getCart(){
  return JSON.parse(localStorage.getItem("cart")) || [];
}
function renderInvoice(){

const cart = getCart();
const tbody=document.querySelector("#invoiceTable tbody");
tbody.innerHTML="";
let total=0;

cart.forEach(item=>{
let itemTotal=item.quantity*item.price;
total+=itemTotal;

tbody.innerHTML+=`
<tr>
<td>${item.name}</td>
<td>${item.quantity}</td>
<td>${item.price}</td>
<td>${itemTotal.toFixed(2)}</td>
</tr>
`;
});

document.getElementById("totalAmount").innerText=total.toFixed(2)+" Ø¯.Ø£";

const inv="INV-"+Date.now();
document.getElementById("invoiceNumber").innerText=inv;
document.getElementById("invoiceDate").innerText=new Date().toLocaleString('ar-JO');
}
  window.addEventListener("storage", renderInvoice);
function saveInvoice(){
const invoiceNumber=document.getElementById("invoiceNumber").innerText;
const total=document.getElementById("totalAmount").innerText;

fetch("save_invoice.php",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
invoice_number:invoiceNumber,
customer_name:document.getElementById("customerName").value,
customer_phone:document.getElementById("customerPhone").value,
total:total,
items:cart
})
}).then(()=>loadArchive());
}

function loadArchive(){
fetch("get_invoices.php")
.then(res=>res.json())
.then(data=>{
const tbody=document.querySelector("#archiveTable tbody");
tbody.innerHTML="";
data.forEach(inv=>{
tbody.innerHTML+=`
<tr>
<td>${inv.invoice_number}</td>
<td>${inv.customer_name}</td>
<td>${inv.customer_phone}</td>
<td>${inv.total}</td>
<td>${inv.created_at}</td>
</tr>
`;
});
});
}

function downloadImage(){
html2canvas(document.querySelector("#invoiceCard"))
.then(canvas=>{
const link=document.createElement("a");
link.download="invoice.png";
link.href=canvas.toDataURL();
link.click();
});
}

function sendWhatsApp(){
const phone=document.getElementById("customerPhone").value;
const total=document.getElementById("totalAmount").innerText;
const name=document.getElementById("customerName").value;

let msg=`ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${name}\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total}`;
window.open(`https://wa.me/962${phone}?text=`+encodeURIComponent(msg));
}

function exportExcel(){
fetch("get_invoices.php")
.then(res=>res.json())
.then(data=>{
const ws=XLSX.utils.json_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Invoices");
XLSX.writeFile(wb,"Invoices.xlsx");
});
}

renderInvoice();
loadArchive();
function saveCustomerOnly(){

fetch("save_invoice.php",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
invoice_number: "CUST-"+Date.now(),
customer_name: document.getElementById("customerName").value,
customer_phone: document.getElementById("customerPhone").value,
total: 0,
items: []
})
}).then(()=>{
  loadArchive();
});
}
</script>
  
</body>
</html>
